# Exercise API Updates Summary

This document summarizes the recent updates to the Exercise API endpoints, focusing on the Coach Notes and Exercise Types features.

## Key Changes

### 1. Instructions → Coach Notes Migration

The single `instructions` text field has been replaced with a structured `coachNotes` array:

**Before:**
- Single text field for all instructions
- Limited formatting options
- Difficult to manage step-by-step guidance

**After:**
- Array of coach notes, each with:
  - `id`: Unique identifier (generated by API)
  - `text`: Instruction text (max 1000 chars)
  - `order`: Display order (0-based)
- Better organization and reordering capabilities
- Clearer step-by-step presentation

### 2. New Exercise Types Feature

Exercises can now be categorized by type (this is a **read-only** reference table):
- **Warmup**: Preparation exercises
- **Workout**: Main training exercises
- **Cooldown**: Recovery exercises
- **Rest**: Rest periods

**Critical Business Rules**:
1. Every exercise MUST have at least one exercise type
2. The "Rest" type CANNOT be combined with other types
3. An exercise can have either:
   - Rest only, OR
   - Any combination of Warmup, Workout, and Cooldown
4. An exercise CANNOT have all four types

**UI Requirements**:
- When "Rest" is selected, automatically deselect other types
- When "Rest" is selected, disable other type options
- Validate on client-side before API submission

### 3. Updated Response Structure

The API now returns a paginated response with metadata:

**Response Structure:**
```javascript
{
  items: [...], // Array of exercises
  currentPage: 1,
  pageSize: 10,
  totalCount: 150,
  totalPages: 15,
  hasPreviousPage: false,
  hasNextPage: true
}
```

### 4. Enhanced Exercise Object Structure

**Key Changes:**
- All fields use camelCase naming (e.g., `isUnilateral`, `imageUrl`, `videoUrl`)
- New `isActive` field for soft-delete support
- Enhanced reference objects with `value` and `description` fields

**Muscle Groups Structure:**
```javascript
// Response
muscleGroups: [
  {
    muscleGroup: { id: "musclegroup-uuid", name: "Quadriceps" },
    role: { id: "musclerole-uuid", value: "Primary", name: "Primary" }
  }
]

// Request
muscleGroups: [
  {
    muscleGroupId: "musclegroup-uuid",
    muscleRoleId: "musclerole-uuid"
  }
]
```

**Other Reference Arrays:**
```javascript
// All now return objects with id and name
equipment: [{ id: "equipment-uuid", name: "Barbell" }],
bodyParts: [{ id: "bodypart-uuid", name: "Upper Back" }],
movementPatterns: [{ id: "pattern-uuid", name: "Push" }]
```

## Updated Endpoints

### Exercise Endpoints

All exercise endpoints now use the new structure:

1. **GET /api/exercises** - Returns paginated response with items array
   - Query params: `page`, `pageSize`, `name`, `difficultyId`, `isActive`, `muscleGroupIds[]`, `equipmentIds[]`, `exerciseTypeIds[]`
2. **GET /api/exercises/{id}** - Returns single exercise with full details
3. **POST /api/exercises** - Create with coach notes array and reference IDs
   - Returns 201 Created with the created exercise
4. **PUT /api/exercises/{id}** - Update with coach notes array and reference IDs
   - Returns 204 No Content on success
5. **DELETE /api/exercises/{id}** - Soft-delete if referenced, hard-delete otherwise
   - Returns 204 No Content on success

### New Reference Table Endpoints

**Exercise Types:**
- **GET /api/ReferenceTables/ExerciseTypes** - Get all exercise types
- **GET /api/ReferenceTables/ExerciseTypes/{id}** - Get by ID
- **GET /api/ReferenceTables/ExerciseTypes/ByValue/{value}** - Get by value

**Muscle Roles:**
- **GET /api/ReferenceTables/MuscleRoles** - Get all muscle roles (Primary, Secondary, Stabilizer)

## Implementation Checklist

### Backend (Already Completed)
- ✅ Database migration for coach notes
- ✅ Database migration for exercise types
- ✅ Updated DTOs and models
- ✅ Updated controllers and services
- ✅ Added validation rules
- ✅ Unit and integration tests

### Frontend (To Be Implemented)
- [ ] Update ExerciseService to handle new paginated response structure
- [ ] Create CoachNotesEditor component for ordered instructions
- [ ] Create ExerciseTypeSelector component with Rest type validation
- [ ] Update ExerciseForm to use all new field names (camelCase)
- [ ] Update ExerciseList to:
  - Display exercise types as badges
  - Show active/inactive status
  - Handle new pagination metadata
- [ ] Add validation for Rest type exclusivity
- [ ] Update reference data loading to include new tables
- [ ] Implement filtering by isActive status

## Quick Reference

### Creating an Exercise
```javascript
const newExercise = {
  name: "Barbell Squat",
  description: "Fundamental lower body exercise",
  coachNotes: [
    { text: "Position bar on upper back", order: 0 },
    { text: "Keep chest up, core engaged", order: 1 },
    { text: "Lower to parallel or below", order: 2 }
  ],
  exerciseTypeIds: ["exercisetype-workout-id"],
  difficultyId: "difficultylevel-intermediate-id",
  isUnilateral: false,
  imageUrl: null,
  videoUrl: null,
  muscleGroups: [
    {
      muscleGroupId: "musclegroup-quadriceps-id",
      muscleRoleId: "musclerole-primary-id"
    },
    {
      muscleGroupId: "musclegroup-glutes-id",
      muscleRoleId: "musclerole-secondary-id"
    }
  ],
  equipmentIds: ["equipment-barbell-id"],
  bodyPartIds: [],
  movementPatternIds: ["pattern-squat-id"]
};

// POST request
const response = await fetch('/api/exercises', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify(newExercise)
});

const createdExercise = await response.json();
```

### Validating Exercise Types
```javascript
function validateExerciseTypes(selectedTypeIds, allTypes) {
  const selectedTypes = selectedTypeIds.map(id => 
    allTypes.find(t => t.id === id)
  );
  
  const hasRest = selectedTypes.some(t => t.value === 'Rest');
  const hasOthers = selectedTypes.some(t => t.value !== 'Rest');
  
  if (hasRest && hasOthers) {
    throw new Error('Rest type cannot be combined with other exercise types');
  }
}
```

## Related Documentation

- [Full API Integration Guide](./api-exercise-crud-integration.md)
- [Coach Notes Migration Guide](./api-coach-notes-migration.md)
- [Exercise Types Reference](./api-exercise-types-reference.md)
- [Reference Tables Overview](./features/reference-tables/overview.md)
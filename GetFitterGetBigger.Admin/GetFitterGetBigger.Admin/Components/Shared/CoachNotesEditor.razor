@using GetFitterGetBigger.Admin.Models.Dtos

<div class="space-y-4">
    <div class="flex justify-between items-center">
        <h3 class="text-lg font-medium text-gray-900">Coach Notes</h3>
        <button type="button" @onclick="AddNote" class="btn btn-secondary btn-sm">
            <i class="fas fa-plus mr-1"></i>
            Add Note
        </button>
    </div>

    @if (Notes.Any())
    {
        <div class="space-y-2">
            @for (var i = 0; i < Notes.Count; i++)
            {
                var index = i; // Capture for closure
                var note = Notes[index];
                
                <div class="border rounded-lg p-4 bg-gray-50">
                    <div class="flex items-start space-x-3">
                        <div class="flex flex-col space-y-1">
                            <button type="button" 
                                    @onclick="() => MoveNoteUp(index)"
                                    disabled="@(index == 0)"
                                    class="btn btn-icon btn-sm @(index == 0 ? "opacity-50 cursor-not-allowed" : "")"
                                    title="Move up">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <button type="button" 
                                    @onclick="() => MoveNoteDown(index)"
                                    disabled="@(index == Notes.Count - 1)"
                                    class="btn btn-icon btn-sm @(index == Notes.Count - 1 ? "opacity-50 cursor-not-allowed" : "")"
                                    title="Move down">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-sm font-medium text-gray-700">
                                    Step @(index + 1)
                                </label>
                                <span class="text-xs text-gray-500">
                                    @note.Text.Length / 1000 characters
                                </span>
                            </div>
                            <textarea 
                                value="@note.Text"
                                @onchange="@(e => UpdateNoteText(index, e.Value?.ToString() ?? string.Empty))"
                                class="form-textarea w-full"
                                rows="3"
                                maxlength="1000"
                                placeholder="Enter coaching instruction...">
                            </textarea>
                            @if (note.Text.Length > 900)
                            {
                                <p class="text-xs text-yellow-600 mt-1">
                                    @(1000 - note.Text.Length) characters remaining
                                </p>
                            }
                        </div>
                        
                        <button type="button" 
                                @onclick="() => RemoveNote(index)"
                                class="btn btn-icon btn-sm text-red-600 hover:text-red-800"
                                title="Remove note">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="text-center py-8 text-gray-500">
            <i class="fas fa-clipboard-list text-4xl mb-2"></i>
            <p>No coach notes added yet.</p>
            <p class="text-sm">Click "Add Note" to get started.</p>
        </div>
    }
</div>

@code {
    [Parameter] public List<CoachNoteCreateDto> Notes { get; set; } = new();
    [Parameter] public EventCallback<List<CoachNoteCreateDto>> NotesChanged { get; set; }

    private async Task AddNote()
    {
        Notes.Add(new CoachNoteCreateDto 
        { 
            Text = string.Empty,
            Order = Notes.Count
        });
        await NotifyChange();
    }

    private async Task RemoveNote(int index)
    {
        Notes.RemoveAt(index);
        ReorderNotes();
        await NotifyChange();
    }

    private async Task UpdateNoteText(int index, string text)
    {
        if (index >= 0 && index < Notes.Count)
        {
            Notes[index].Text = text.Length > 1000 ? text.Substring(0, 1000) : text;
            await NotifyChange();
        }
    }

    private async Task MoveNoteUp(int index)
    {
        if (index > 0)
        {
            var temp = Notes[index];
            Notes[index] = Notes[index - 1];
            Notes[index - 1] = temp;
            ReorderNotes();
            await NotifyChange();
        }
    }

    private async Task MoveNoteDown(int index)
    {
        if (index < Notes.Count - 1)
        {
            var temp = Notes[index];
            Notes[index] = Notes[index + 1];
            Notes[index + 1] = temp;
            ReorderNotes();
            await NotifyChange();
        }
    }

    private void ReorderNotes()
    {
        for (var i = 0; i < Notes.Count; i++)
        {
            Notes[i].Order = i;
        }
    }

    private async Task NotifyChange()
    {
        await NotesChanged.InvokeAsync(Notes);
    }
}